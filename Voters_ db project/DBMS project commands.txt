create table citizen
(Aadhaar_no varchar(12) primary key,
first_name text,
surname text,
first_name_relative text,
surname_relative text,
type_of_relation text,
DOB date,
gender char(1),
house_no_perm text,
locality_perm text,
city_perm text,
pincode_perm int(6),
district_perm text,
State_perm text);

LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/Citizen.txt' 
INTO TABLE citizen_copy 
FIELDS TERMINATED BY ',' 
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS;

create table constituency
(constituency_id int(2) primary key,
const_name varchar(30) not null,
const_district varchar(30) not null,
const_state varchar(30) not null);

CREATE TABLE VOTERS(
epic_no VARCHAR(12) PRIMARY KEY,
aadhaar_no VARCHAR(12) NOT NULL,
house_no_cur text NOT NULL,
locality_cur text NOT NULL,
town_cur text NOT NULL,
pincode_cur text NOT NULL,
district_cur text NOT NULL,
state_cur text NOT NULL
);

/*FINAL*/

CREATE DATABASE ELECTORAL_ROLL;
USE ELECTORAL_ROLL;
CREATE TABLE CONSTITUENCY
(CONSTITUENCY_ID INT(2) PRIMARY KEY,
CONSTITUENCY_NAME VARCHAR(30) NOT NULL,
CONSTITUENCY_DISTRICT VARCHAR(30) NOT NULL,
CONSTITUENCY_STATE VARCHAR(30) NOT NULL);

LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/Constituencytab.txt' 
INTO TABLE CONSTITUENCY 
FIELDS TERMINATED BY '\t' 
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS;

CREATE INDEX CONSTITUENCY_NAME
ON CONSTITUENCY (CONSTITUENCY_NAME);

CREATE TABLE CITIZEN
(AADHAAR_NO VARCHAR(12) PRIMARY KEY,
FIRST_NAME VARCHAR(30) NOT NULL,
SURNAME VARCHAR(30) NOT NULL,
FIRST_NAME_RELATIVE VARCHAR(30) NOT NULL,
SURNAME_RELATIVE VARCHAR(30) NOT NULL,
TYPE_OF_RELATION VARCHAR(30) NOT NULL,
DOB DATE NOT NULL,
GENDER CHAR(1) NOT NULL,
HOUSE_NO_PERM VARCHAR(30) NOT NULL,
LOCALITY_PERM VARCHAR(30) NOT NULL,
TOWN_PERM VARCHAR(30) NOT NULL,
PIN_CODE_PERM VARCHAR(6) NOT NULL,
DISTRICT_PERM VARCHAR(30) NOT NULL,
STATE_PERM VARCHAR(30) NOT NULL);

LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/Citizentab.txt' 
INTO TABLE CITIZEN 
FIELDS TERMINATED BY '\t' 
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS;

SELECT FIRST_NAME, DOB, CURDATE(),
TIMESTAMPDIFF(YEAR, DOB, CURDATE()) AS AGE
FROM CITIZEN
HAVING AGE<18;

CREATE INDEX FIRST_NAME
ON CITIZEN (FIRST_NAME);

CREATE INDEX SURNAME
ON CITIZEN (SURNAME);

CREATE TABLE VOTERS
(AADHAAR_NO VARCHAR(12) NOT NULL,
FOREIGN KEY(AADHAAR_NO) REFERENCES CITIZEN(AADHAAR_NO)
ON DELETE CASCADE
ON UPDATE CASCADE,
EPIC_NO VARCHAR(10) PRIMARY KEY,
HOUSE_NO_CUR VARCHAR(6) NOT NULL,
LOCALITY_CUR VARCHAR(20) NOT NULL,
TOWN_CUR VARCHAR(20) NOT NULL,
PIN_CODE_CUR VARCHAR(6) NOT NULL,
DISTRICT_CUR VARCHAR(20) NOT NULL,
STATE_CUR VARCHAR(20) NOT NULL);

LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/Votertab.txt' 
INTO TABLE VOTERS 
FIELDS TERMINATED BY '\t' 
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS;

CREATE INDEX AADHAAR_NO
ON VOTERS (AADHAAR_NO);

/*rutvi's table*/
CREATE TABLE POLLING_STATION
(CONSTITUENCY_ID INT(2) NOT NULL,
FOREIGN KEY(CONSTITUENCY_ID) REFERENCES CONSTITUENCY(CONSTITUENCY_ID)
ON DELETE CASCADE
ON UPDATE CASCADE,
STATION_ID INT(4) PRIMARY KEY,
POLL_STN_NAME VARCHAR(40) NOT NULL,
POLL_BUILDING_NAME TEXT NOT NULL,
POLL_LOCALITY VARCHAR(40) NOT NULL,
POLL_TOWN VARCHAR(40) NOT NULL,
POLL_PIN_CODE VARCHAR(40) NOT NULL
);
LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/poll_station.csv' 
INTO TABLE POLLING_STATION
FIELDS TERMINATED BY ',' 
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS;

/*my table*/
CREATE TABLE POLLING_STATION2
(CONSTITUENCY_ID INT(2) NOT NULL,
FOREIGN KEY(CONSTITUENCY_ID) REFERENCES CONSTITUENCY(CONSTITUENCY_ID)
ON DELETE CASCADE
ON UPDATE CASCADE,
STATION_ID INT(4) PRIMARY KEY,
POLL_STN_NAME VARCHAR(40) NOT NULL,
POLL_BUILDING_NAME TEXT NOT NULL,
POLL_LOCALITY VARCHAR(40) NOT NULL,
POLL_TOWN VARCHAR(40) NOT NULL,
POLL_PIN_CODE VARCHAR(40) NOT NULL
);
LOAD DATA INFILE 'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/PollStntab.txt' 
INTO TABLE POLLING_STATION2
FIELDS TERMINATED BY '\t' 
LINES TERMINATED BY '\r\n'
IGNORE 1 ROWS;

CREATE INDEX POLL_STN_NAME
ON POLLING_STATION2 (POLL_STN_NAME);

CREATE TABLE VCP
(EPIC_NO VARCHAR(10) NOT NULL,
FOREIGN KEY(EPIC_NO) REFERENCES VOTERS(EPIC_NO)
ON DELETE CASCADE
ON UPDATE CASCADE,
STATION_ID INT(4) NOT NULL,
FOREIGN KEY(STATION_ID) REFERENCES POLLING_STATION(STATION_ID)
ON DELETE CASCADE
ON UPDATE CASCADE,
CONSTITUENCY_ID INT(2) NOT NULL,
FOREIGN KEY(CONSTITUENCY_ID) REFERENCES CONSTITUENCY(CONSTITUENCY_ID)
ON DELETE CASCADE
ON UPDATE CASCADE);

/*imported VCP via workbench*/

DROP TRIGGER NEW_VOTER;

/*method 2*/
DELIMITER //
CREATE TRIGGER NEW_VOTER AFTER INSERT ON CITIZEN
FOR EACH ROW
BEGIN
IF (SELECT TIMESTAMPDIFF(YEAR, NEW.DOB, CURDATE())>=18) THEN
INSERT INTO VOTERS (AADHAAR_NO,EPIC_NO,HOUSE_NO_CUR,LOCALITY_CUR,TOWN_CUR,PIN_CODE_CUR,DISTRICT_CUR,STATE_CUR)
VALUES (NEW.AADHAAR_NO,UUID(),NEW.HOUSE_NO_PERM,NEW.LOCALITY_PERM,NEW.TOWN_PERM,NEW.PIN_CODE_PERM,NEW.DISTRICT_PERM,NEW.STATE_PERM);
END IF;
END//

/*full trigger*/
DELIMITER //
CREATE TRIGGER NEW_VOTER AFTER INSERT ON CITIZEN
FOR EACH ROW
BEGIN
IF (SELECT TIMESTAMPDIFF(YEAR, NEW.DOB, CURDATE())>=18) THEN
INSERT INTO VOTERS (AADHAAR_NO,EPIC_NO,HOUSE_NO_CUR,LOCALITY_CUR,TOWN_CUR,PIN_CODE_CUR,DISTRICT_CUR,STATE_CUR)
VALUES (NEW.AADHAAR_NO,UUID(),NEW.HOUSE_NO_PERM,NEW.LOCALITY_PERM,NEW.TOWN_PERM,NEW.PIN_CODE_PERM,NEW.DISTRICT_PERM,NEW.STATE_PERM);
INSERT INTO VCP (EPIC_NO)
VALUES(UUID());
END IF;
END//

ALTER TABLE VCP
MODIFY STATION_ID INT(4);

ALTER TABLE VCP
MODIFY CONSTITUENCY_ID INT(2);

INSERT INTO CITIZEN(AADHAAR_NO,FIRST_NAME,SURNAME,
FIRST_NAME_RELATIVE,SURNAME_RELATIVE,
TYPE_OF_RELATION,DOB,GENDER,HOUSE_NO_PERM,
LOCALITY_PERM,TOWN_PERM,PIN_CODE_PERM,
DISTRICT_PERM,STATE_PERM)
VALUES("000000000000","ABC","XYZ",
"abc","xyz",
"LETTERS","1981-10-28","F","A 103",
"VILE PARLE","S.V.RD.","400512",
"MUMBAI SUBURBAN","STATE");

INSERT INTO CITIZEN(AADHAAR_NO,FIRST_NAME,SURNAME,
FIRST_NAME_RELATIVE,SURNAME_RELATIVE,
TYPE_OF_RELATION,DOB,GENDER,HOUSE_NO_PERM,
LOCALITY_PERM,TOWN_PERM,PIN_CODE_PERM,
DISTRICT_PERM,STATE_PERM)
VALUES("000011110000","ABC","XYZ",
"abc","xyz",
"LETTERS","2015-10-28","F","A 103",
"VILE PARLE","S.V.RD.","400512",
"MUMBAI SUBURBAN","STATE");

ALTER TABLE VCP
DROP FOREIGN KEY vcp_ibfk_4;

ALTER TABLE VOTERS
MODIFY EPIC_NO VARCHAR(255);

ALTER TABLE VCP
MODIFY EPIC_NO VARCHAR(255);

ALTER TABLE VCP
ADD FOREIGN KEY(EPIC_NO)
REFERENCES VOTERS(EPIC_NO)
ON DELETE CASCADE
ON UPDATE CASCADE;

DELETE FROM CITIZEN
WHERE AADHAAR_NO="000000000000";

INSERT INTO CITIZEN(AADHAAR_NO,FIRST_NAME,SURNAME,
FIRST_NAME_RELATIVE,SURNAME_RELATIVE,
TYPE_OF_RELATION,DOB,GENDER,HOUSE_NO_PERM,
LOCALITY_PERM,TOWN_PERM,PIN_CODE_PERM,
DISTRICT_PERM,STATE_PERM)
VALUES("000022220000","ABC","XYZ",
"abc","xyz",
"LETTERS","2002-01-02","F","A 103",
"SAVNER","S.V.RD.","400512",
"MUMBAI SUBURBAN","STATE");

SELECT REPLACE(RIGHT(UUID(),10),'-','');

INSERT INTO CITIZEN(AADHAAR_NO,FIRST_NAME,SURNAME,
FIRST_NAME_RELATIVE,SURNAME_RELATIVE,
TYPE_OF_RELATION,DOB,GENDER,HOUSE_NO_PERM,
LOCALITY_PERM,TOWN_PERM,PIN_CODE_PERM,
DISTRICT_PERM,STATE_PERM)
VALUES("000033330000","ABC","XYZ",
"abc","xyz",
"LETTERS","1990-10-28","F","A 103",
"UMRED","S.V.RD.","400512",
"MUMBAI SUBURBAN","STATE");

INSERT INTO CITIZEN(AADHAAR_NO,FIRST_NAME,SURNAME,
FIRST_NAME_RELATIVE,SURNAME_RELATIVE,
TYPE_OF_RELATION,DOB,GENDER,HOUSE_NO_PERM,
LOCALITY_PERM,TOWN_PERM,PIN_CODE_PERM,
DISTRICT_PERM,STATE_PERM)
VALUES("000044440000","ABC","XYZ",
"abc","xyz",
"LETTERS","2002-11-02","F","A 103",
"DEOLALI","S.V.RD.","400512",
"MUMBAI SUBURBAN","STATE");

INSERT INTO CITIZEN(AADHAAR_NO,FIRST_NAME,SURNAME,
FIRST_NAME_RELATIVE,SURNAME_RELATIVE,
TYPE_OF_RELATION,DOB,GENDER,HOUSE_NO_PERM,
LOCALITY_PERM,TOWN_PERM,PIN_CODE_PERM,
DISTRICT_PERM,STATE_PERM)
VALUES("000055550000","ABC","XYZ",
"abc","xyz",
"LETTERS","2001-11-02","F","A 103",
"GUHAGAR","S.V.RD.","400512",
"MUMBAI SUBURBAN","STATE");

select concat(RIGHT(lpad(conv(floor(rand()*pow(36,6)), 10, 36), 6, 0),4),RIGHT(RAND(),6));

/*The statement refers to the column as NEW.amount which means 
“the value of the amount column to be inserted into the new row.”*/

DELIMITER //
CREATE TRIGGER NEW_VOTER AFTER INSERT ON CITIZEN
FOR EACH ROW
BEGIN
IF (SELECT TIMESTAMPDIFF(YEAR, NEW.DOB, CURDATE())>=18) THEN
INSERT INTO VOTERS (AADHAAR_NO,EPIC_NO,HOUSE_NO_CUR,LOCALITY_CUR,TOWN_CUR,PIN_CODE_CUR,DISTRICT_CUR,STATE_CUR)
VALUES (NEW.AADHAAR_NO,select concat(RIGHT(lpad(conv(floor(rand()*pow(36,6)), 10, 36), 6, 0),4),RIGHT(RAND(),6)),NEW.HOUSE_NO_PERM,NEW.LOCALITY_PERM,NEW.TOWN_PERM,NEW.PIN_CODE_PERM,NEW.DISTRICT_PERM,NEW.STATE_PERM);
INSERT INTO VCP (EPIC_NO)
VALUES(select concat(RIGHT(lpad(conv(floor(rand()*pow(36,6)), 10, 36), 6, 0),4));
END IF;
/*IF (
SELECT NEW.LOCALITY_PERM, CONSTITUENCY.CONSTITUENCY_NAME, CONSTITUENCY.CONSTITUENCY_ID
FROM CITIZEN INNER JOIN CONSTITUENCY
ON CITIZEN.LOCALITY_PERM=CONSTITUENCY.CONSTITUENCY_NAME
WHERE NEW.LOCALITY_PERM=CONSTITUENCY.CONSTITUENCY_NAME
) THEN*/
UPDATE VCP
INNER JOIN CITIZEN ON VCP.LOCALITY_PERM=CONSTITUENCY.CONSTITUENCY_NAME
WHERE 
SET CONSTITUENCY_ID=
END//

DELIMITER //
CREATE TRIGGER CHANGE_CONSTITUENCY AFTER UPDATE ON VOTERS
FOR EACH ROW
BEGIN
UPDATE VCP
INNER JOIN VOTERS ON VCP.EPIC_NO=VOTERS.EPIC_NO
INNER JOIN CONSTITUENCY ON VCP.CONSTITUENCY_ID=CONSTITUENCY.CONSTITUENCY_ID
SET VCP.CONSTITUENCY_ID=CONSTITUENCY.CONSTITUENCY_ID
WHERE VOTERS.LOCALITY_CUR=NEW.LOCALITY_CUR AND VOTERS.LOCALITY_CUR=CONSTITUENCY.CONSTITUENCY_NAME;
END//

UPDATE VOTERS
SET LOCALITY_CUR="HINGNA"
WHERE EPIC_NO="R2RX214239";

UPDATE VOTERS
SET LOCALITY_CUR="HINGNA"
WHERE EPIC_NO="DW6I392943";

/*all 3*/
DELIMITER //
CREATE TRIGGER NEW_VOTER AFTER INSERT ON CITIZEN
FOR EACH ROW
BEGIN
IF (SELECT TIMESTAMPDIFF(YEAR, NEW.DOB, CURDATE())>=18) THEN
SET @EPIC=concat(RIGHT(lpad(conv(floor(rand()*pow(36,6)), 10, 36), 6, 0),4),RIGHT(RAND(),6));
INSERT INTO VOTERS (AADHAAR_NO,EPIC_NO,HOUSE_NO_CUR,LOCALITY_CUR,TOWN_CUR,PIN_CODE_CUR,DISTRICT_CUR,STATE_CUR)
VALUES (NEW.AADHAAR_NO,@EPIC,NEW.HOUSE_NO_PERM,NEW.LOCALITY_PERM,NEW.TOWN_PERM,NEW.PIN_CODE_PERM,NEW.DISTRICT_PERM,NEW.STATE_PERM);
INSERT INTO VCP (EPIC_NO)
VALUES(@EPIC);
END IF;
END//

/*after update final for non-repetitve values*/
DELIMITER //
CREATE TRIGGER CHANGE_CONSTITUENCY AFTER UPDATE ON VOTERS
FOR EACH ROW
BEGIN
SET @CONST=(SELECT CONSTITUENCY.CONSTITUENCY_ID FROM
VOTERS INNER JOIN CONSTITUENCY
ON VOTERS.LOCALITY_CUR=CONSTITUENCY.CONSTITUENCY_NAME
WHERE VOTERS.LOCALITY_CUR=NEW.LOCALITY_CUR);
UPDATE VCP
INNER JOIN VOTERS ON VCP.EPIC_NO=VOTERS.EPIC_NO
SET VCP.CONSTITUENCY_ID=@CONST
WHERE VOTERS.LOCALITY_CUR=NEW.LOCALITY_CUR;
END//

/*BEFORE UPDATE doesn't work since how will you assign a constituency BEFORE you take the NEW locality value?!*/

/*final const_id*/
SET @CONST=(SELECT CONSTITUENCY.CONSTITUENCY_ID FROM
VOTERS INNER JOIN CONSTITUENCY
ON VOTERS.LOCALITY_CUR=CONSTITUENCY.CONSTITUENCY_NAME
WHERE VOTERS.LOCALITY_CUR IN ("UMRED"));


/*decide the type of join on the basis of ON values (?)*/

/*!!!update address of an existing voter final!!!*/

/*!!!the absolute final trigger 2!!!*/

DELIMITER //
CREATE TRIGGER CHANGE_POLLING_STN AFTER UPDATE ON VOTERS
FOR EACH ROW
BEGIN
SELECT CONSTITUENCY_ID 
INTO @CONST 
FROM VOTERS INNER JOIN CONSTITUENCY
ON VOTERS.LOCALITY_CUR=CONSTITUENCY.CONSTITUENCY_NAME
WHERE VOTERS.LOCALITY_CUR=NEW.LOCALITY_CUR
LIMIT 1;

UPDATE VCP
INNER JOIN VOTERS ON VCP.EPIC_NO=VOTERS.EPIC_NO
SET VCP.CONSTITUENCY_ID=@CONST
WHERE VOTERS.LOCALITY_CUR=NEW.LOCALITY_CUR;

SELECT STATION_ID
INTO @POLL
FROM POLLING_STATION
WHERE POLLING_STATION.CONSTITUENCY_ID=@CONST
LIMIT 1;

UPDATE VCP
INNER JOIN VOTERS ON VCP.EPIC_NO=VOTERS.EPIC_NO
SET VCP.STATION_ID=@POLL
WHERE VOTERS.LOCALITY_CUR=NEW.LOCALITY_CUR;
END//


/*auto-assignemnt of poll_stn when INSERT INTO
CITIZEN*/

/*!!!the absolute final trigger 1!!!*/

DELIMITER //
CREATE TRIGGER NEW_VOTER AFTER INSERT ON CITIZEN
FOR EACH ROW
BEGIN

IF (SELECT TIMESTAMPDIFF(YEAR, NEW.DOB, CURDATE())>=18) THEN
SET @EPIC=concat(RIGHT(lpad(conv(floor(rand()*pow(36,6)), 10, 36), 6, 0),4),RIGHT(RAND(),6));
INSERT INTO VOTERS (AADHAAR_NO,EPIC_NO,HOUSE_NO_CUR,LOCALITY_CUR,TOWN_CUR,PIN_CODE_CUR,DISTRICT_CUR,STATE_CUR)
VALUES (NEW.AADHAAR_NO,@EPIC,NEW.HOUSE_NO_PERM,NEW.LOCALITY_PERM,NEW.TOWN_PERM,NEW.PIN_CODE_PERM,NEW.DISTRICT_PERM,NEW.STATE_PERM);

SET @LOC=NEW.LOCALITY_PERM;

INSERT INTO VCP (EPIC_NO)
VALUES(@EPIC);
END IF;

SELECT CONSTITUENCY_ID 
INTO @CONST 
FROM VOTERS INNER JOIN CONSTITUENCY
ON VOTERS.LOCALITY_CUR=CONSTITUENCY.CONSTITUENCY_NAME
WHERE VOTERS.LOCALITY_CUR=@LOC
LIMIT 1;

UPDATE VCP
INNER JOIN VOTERS ON VCP.EPIC_NO=VOTERS.EPIC_NO
SET VCP.CONSTITUENCY_ID=@CONST
WHERE VOTERS.LOCALITY_CUR=@LOC;

SELECT STATION_ID
INTO @POLL
FROM POLLING_STATION
WHERE POLLING_STATION.CONSTITUENCY_ID=@CONST
LIMIT 1;

UPDATE VCP
INNER JOIN VOTERS ON VCP.EPIC_NO=VOTERS.EPIC_NO
SET VCP.STATION_ID=@POLL
WHERE VOTERS.LOCALITY_CUR=@LOC;
END//

UPDATE VOTERS
SET LOCALITY_CUR = "Ulhasnagar", house_no_cur = "D 2024", town_cur = "MUMBAI", PIN_CODE_CUR = "400034", DISTRICT_CUR = "MUMBAI", STATE_CUR = "MAHA"
WHERE EPIC_NO = "YTR1606995";

INSERT INTO CITIZEN (AADHAAR_NO, FIRST_NAME, SURNAME, FIRST_NAME_RELATIVE, SURNAME_RELATIVE,
TYPE_OF_RELATION, DOB, GENDER, HOUSE_NO_PERM,
LOCALITY_PERM, TOWN_PERM, PIN_CODE_PERM, DISTRICT_PERM, STATE_PERM)
VALUES("111111111111", "D", "f", "D", "F", "F", "2000-10-10", "F", "A 102", "LOCALITY", "CITY", "400054", "DIST", "MAHAHAHA");
